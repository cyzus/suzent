"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[695],{4940(e,n,s){s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"concepts/memory/troubleshooting","title":"Troubleshooting","description":"Vector Dimension Mismatch","source":"@site/../docs/02-concepts/memory/troubleshooting.md","sourceDirName":"02-concepts/memory","slug":"/concepts/memory/troubleshooting","permalink":"/suzent/docs/concepts/memory/troubleshooting","draft":false,"unlisted":false,"editUrl":"https://github.com/cyzus/suzent/tree/main/website/../docs/02-concepts/memory/troubleshooting.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Configuration","permalink":"/suzent/docs/concepts/memory/configuration"},"next":{"title":"Suzent Skills Guide","permalink":"/suzent/docs/concepts/skills/"}}');var i=s(4848),l=s(8453);const o={},c="Troubleshooting",t={},d=[{value:"Vector Dimension Mismatch",id:"vector-dimension-mismatch",level:2},{value:"Slow Search",id:"slow-search",level:2},{value:"No Memories Extracted",id:"no-memories-extracted",level:2},{value:"Connection Pool Exhausted",id:"connection-pool-exhausted",level:2},{value:"High Memory Usage",id:"high-memory-usage",level:2},{value:"Connection Failed",id:"connection-failed",level:2},{value:"Schema Not Found",id:"schema-not-found",level:2},{value:"Import Errors",id:"import-errors",level:2},{value:"Embedding Generation Fails",id:"embedding-generation-fails",level:2},{value:"Debug Commands",id:"debug-commands",level:2},{value:"Getting Help",id:"getting-help",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"troubleshooting",children:"Troubleshooting"})}),"\n",(0,i.jsx)(n.h2,{id:"vector-dimension-mismatch",children:"Vector Dimension Mismatch"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Error:"})," ",(0,i.jsx)(n.code,{children:"ERROR: expected 1536 dimensions, not 3072"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Cause:"})," Embedding model dimension doesn't match database."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Solution:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- Check current\n\\d+ archival_memories\n\n-- Alter table\nALTER TABLE archival_memories ALTER COLUMN embedding TYPE vector(3072);\n\n-- Rebuild index\nDROP INDEX idx_archival_memories_embedding;\nCREATE INDEX idx_archival_memories_embedding ON archival_memories\nUSING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);\n\nANALYZE archival_memories;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"slow-search",children:"Slow Search"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Symptoms:"})," Search taking >1 second"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Diagnosis:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:'EXPLAIN ANALYZE\nSELECT * FROM archival_memories\nORDER BY embedding <=> \'[...]\'::vector\nLIMIT 10;\n\n-- Should show "Index Scan", not "Seq Scan"\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Check index exists:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"\\d archival_memories\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Increase lists:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"DROP INDEX idx_archival_memories_embedding;\nCREATE INDEX idx_archival_memories_embedding ON archival_memories\nUSING ivfflat (embedding vector_cosine_ops) WITH (lists = 500);\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Update statistics:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"ANALYZE archival_memories;\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Vacuum:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"VACUUM ANALYZE archival_memories;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"no-memories-extracted",children:"No Memories Extracted"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Checks:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"LLM configured?"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'manager = MemoryManager(\n    store=store,\n    llm_for_extraction="gpt-4o-mini"  # Must be set\n)\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Processing user messages?"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Only extracts from role="user"\nmessage = {"role": "user", "content": "..."}\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"API key set?"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"echo $OPENAI_API_KEY\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Debug logging:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"import logging\nlogging.basicConfig(level=logging.DEBUG)\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"5",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Check report:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"report = await manager.process_message_for_memories(...)\nprint(report)  # Check 'extracted_facts'\n"})}),"\n",(0,i.jsx)(n.h2,{id:"connection-pool-exhausted",children:"Connection Pool Exhausted"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Error:"})," ",(0,i.jsx)(n.code,{children:"asyncpg.exceptions.TooManyConnectionsError"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Increase pool:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"store = PostgresMemoryStore(\n    connection_string,\n    max_size=50  # Increase\n)\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Close connections:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"try:\n    await store.connect()\n    # ...\nfinally:\n    await store.close()\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Check active:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT count(*) FROM pg_stat_activity\nWHERE datname = 'suzent';\n"})}),"\n",(0,i.jsx)(n.h2,{id:"high-memory-usage",children:"High Memory Usage"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Check size:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT pg_size_pretty(pg_total_relation_size('archival_memories'));\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Vacuum:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"VACUUM FULL archival_memories;\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Prune old memories:"})}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Delete low-importance old memories\nawait store.execute("""\n    DELETE FROM archival_memories\n    WHERE created_at < NOW() - INTERVAL \'1 year\'\n        AND importance < 0.3\n        AND access_count < 5\n""")\n'})}),"\n",(0,i.jsx)(n.h2,{id:"connection-failed",children:"Connection Failed"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Error:"})," ",(0,i.jsx)(n.code,{children:"Connection refused"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Check:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker ps\ndocker logs suzent-postgres\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker start suzent-postgres\n"})}),"\n",(0,i.jsx)(n.h2,{id:"schema-not-found",children:"Schema Not Found"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Error:"})," ",(0,i.jsx)(n.code,{children:'relation "archival_memories" does not exist'})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Run setup:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"./scripts/setup_memory_db.sh\n"})}),"\n",(0,i.jsx)(n.p,{children:"Or manually:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"psql -U suzent -h localhost -p 5430 -d suzent < src/suzent/memory/schema.sql\n"})}),"\n",(0,i.jsx)(n.h2,{id:"import-errors",children:"Import Errors"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Error:"})," ",(0,i.jsx)(n.code,{children:"ModuleNotFoundError: No module named 'suzent.memory'"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Install:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"uv sync\n"})}),"\n",(0,i.jsx)(n.h2,{id:"embedding-generation-fails",children:"Embedding Generation Fails"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Error:"})," ",(0,i.jsx)(n.code,{children:"OpenAI API error"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Checks:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"API key valid"}),"\n",(0,i.jsx)(n.li,{children:"Billing enabled"}),"\n",(0,i.jsx)(n.li,{children:"Rate limits not exceeded"}),"\n",(0,i.jsx)(n.li,{children:"Network connectivity"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Retry with backoff:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from tenacity import retry, wait_exponential\n\n@retry(wait=wait_exponential(multiplier=1, min=2, max=10))\nasync def generate_with_retry(text):\n    return await embedding_gen.generate(text)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"debug-commands",children:"Debug Commands"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- Check tables\n\\dt\n\n-- Check indexes\n\\di\n\n-- Check table size\nSELECT pg_size_pretty(pg_relation_size('archival_memories'));\n\n-- Check index size\nSELECT pg_size_pretty(pg_indexes_size('archival_memories'));\n\n-- Check dead tuples\nSELECT n_live_tup, n_dead_tup FROM pg_stat_user_tables\nWHERE tablename = 'archival_memories';\n\n-- Check slow queries\nSELECT * FROM pg_stat_statements\nORDER BY total_time DESC LIMIT 10;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"getting-help",children:"Getting Help"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Enable debug logging"}),"\n",(0,i.jsx)(n.li,{children:"Check logs for errors"}),"\n",(0,i.jsx)(n.li,{children:"Run diagnostic queries"}),"\n",(0,i.jsx)(n.li,{children:"Open issue with: error message, config, logs"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453(e,n,s){s.d(n,{R:()=>o,x:()=>c});var r=s(6540);const i={},l=r.createContext(i);function o(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);